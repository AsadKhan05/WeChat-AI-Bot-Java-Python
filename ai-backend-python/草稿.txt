æˆ‘éœ€è¦çš„æ˜¯è¿è¡Œçš„æ—¶å€™æ¯ä¸ªå¥½å‹ä¸æ˜¯å•ç‹¬çš„æ‰“å¼€ä¸€ä¸ªå¯¹è¯æ¡†ï¼Œè€Œæ˜¯åœ¨åŸç•Œé¢æ¥æ”¶æ¶ˆæ¯å’Œå¯¹è¯å›å¤ï¼Œå¹¶ä¸”ä¿è¯èƒ½å¤Ÿæ¥æ”¶åˆ°æ¶ˆæ¯ï¼Œå¹¶ä¸”ä¿®æ­£é”™è¯¯ï¼Œ
âŒ è·å–æ¶ˆæ¯å¼‚å¸¸: 'WeChat' object has no attribute 'GetListenMessage'
âŒ è·å–æ¶ˆæ¯å¼‚å¸¸: 'WeChat' object has no attribute 'GetListenMessage'
ä»£ç æ–‡ä»¶ä¸ºï¼š
bot_manager.pyæ–‡ä»¶ï¼š
import time
import requests
import threading
import queue
import config
import os
from wxauto import WeChat

class BotManager:
    def __init__(self):
        print("æ­£åœ¨åˆå§‹åŒ–å¾®ä¿¡å®¢æˆ·ç«¯...")
        self.wx = WeChat()
        
        # æ¶ˆæ¯é˜Ÿåˆ—
        self.inbox_queue = queue.Queue()  # æ¥æ”¶æ¶ˆæ¯ï¼ˆæ¨ç»™Javaï¼‰
        self.outbox_queue = queue.Queue() # å‘é€æŒ‡ä»¤ï¼ˆå‘ç»™å¾®ä¿¡ï¼‰
        
        # åˆå§‹åŒ–ç›‘å¬
        self._init_listeners()
        
        # å¯åŠ¨ã€ä¸ŠæŠ¥ã€‘çº¿ç¨‹ (ç½‘ç»œIOå¯ä»¥å¤šçº¿ç¨‹ï¼Œä¸å½±å“UI)
        threading.Thread(target=self._run_inbox_consumer, daemon=True).start()
        
        # âš ï¸ æ³¨æ„ï¼šä¸å†å¯åŠ¨ _run_outbox_consumer çº¿ç¨‹
        # å‘é€é€»è¾‘å°†åˆå¹¶åˆ°ä¸»å¾ªç¯ä¸­

    def _init_listeners(self):
        # åªéœ€è¦æ·»åŠ ç›‘å¬å¯¹è±¡ï¼Œä¸éœ€è¦ä¼ é€’ callbackï¼Œå› ä¸ºæˆ‘ä»¬å°†æ‰‹åŠ¨è·å–æ¶ˆæ¯
        for nickname in config.LISTEN_LIST:
            self.wx.AddListenChat(nickname) #
            print(f"âœ… å·²æ·»åŠ ç›‘å¬: {nickname}")

    def _handle_new_messages(self):
        """
        æ‰‹åŠ¨è·å–ç›‘å¬æ¶ˆæ¯ï¼Œæ›¿ä»£ KeepRunning çš„è‡ªåŠ¨å›è°ƒ
        """
        # GetListenMessage è¿”å›ä¸€ä¸ªå­—å…¸: {chat_obj: [msg_list]}
        msgs = self.wx.GetListenMessage() 
        for chat, msg_list in msgs.items():
            for msg in msg_list:
                # å¤ç”¨ä½ ä¹‹å‰çš„å¤„ç†é€»è¾‘
                self._process_single_message(msg, chat)

    def _process_single_message(self, msg, chat):
        """
        åŸ _on_wx_message çš„é€»è¾‘ç§»åŠ¨åˆ°è¿™é‡Œ
        """
        try:
            # 1. è¿‡æ»¤è‡ªå·±å’Œç³»ç»Ÿæ¶ˆæ¯
            if msg.sender == 'Self' or msg.sender == config.SELF_WX_NAME:
                return
            if msg.type == 'sys':
                return

            print(f"<-- æ”¶åˆ°æ¶ˆæ¯ [{chat.who}]: {msg.content}")

            # 2. å¤„ç†ä¸‹è½½
            content_to_send = msg.content
            if msg.type in ('image', 'video'):
                save_path = msg.download() #
                content_to_send = f"[FILE]{save_path}"
                print(f"    æ–‡ä»¶å·²ä¿å­˜: {save_path}")

            # 3. æ”¾å…¥ä¸ŠæŠ¥é˜Ÿåˆ—
            data = {
                "sender": chat.who,
                "content": content_to_send,
                "type": msg.type,
                "timestamp": int(time.time() * 1000)
            }
            self.inbox_queue.put(data)

        except Exception as e:
            print(f"âŒ æ¶ˆæ¯å¤„ç†å¼‚å¸¸: {e}")

    def add_send_task(self, who, content):
        """å¤–éƒ¨è°ƒç”¨æ¥å£"""
        self.outbox_queue.put({"who": who, "content": content})

    def _process_outbox(self):
        """
        æ£€æŸ¥å¹¶å‘é€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼ˆåœ¨ä¸»çº¿ç¨‹è¿è¡Œï¼Œå®‰å…¨ï¼‰
        """
        while not self.outbox_queue.empty():
            task = self.outbox_queue.get()
            who = task['who']
            content = task['content']
            
            try:
                # åˆ‡æ¢çª—å£
                self.wx.ChatWith(who) #
                
                # å‘é€é€»è¾‘
                if content.startswith("[FILE]"):
                    file_path = content.replace("[FILE]", "")
                    if os.path.exists(file_path):
                        self.wx.SendFiles(file_path)
                    else:
                        print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
                else:
                    self.wx.SendMsg(content) #
                    
                print(f"--> å‘é€æˆåŠŸ: {who} - {content[:10]}...")
                
            except Exception as e:
                print(f"âŒ å‘é€å¤±è´¥: {e}")
            
            # ç®€å•å»¶æ—¶ï¼Œé˜²æ­¢æ“ä½œè¿‡å¿«
            time.sleep(0.5)

    def _run_inbox_consumer(self):
        """ä¸ŠæŠ¥æ¶ˆæ¯çº¿ç¨‹ (HTTPè¯·æ±‚æ˜¯IOå¯†é›†å‹ï¼Œå¯ä»¥ä½¿ç”¨ç‹¬ç«‹çº¿ç¨‹)"""
        print("ğŸ“¡ æ¶ˆæ¯ä¸ŠæŠ¥çº¿ç¨‹å·²å¯åŠ¨")
        while True:
            msg_data = self.inbox_queue.get()
            try:
                requests.post(config.JAVA_API_URL, json=msg_data, timeout=5)
            except Exception as e:
                print(f"âŒ è¿æ¥ Java å¤±è´¥: {e}")
            finally:
                self.inbox_queue.task_done()

    def run(self):
        """
        ä¸»ç¨‹åºå…¥å£ï¼šè‡ªå®šä¹‰äº‹ä»¶å¾ªç¯
        """
        print("ğŸ‘€ å¾®ä¿¡ç›‘å¬æœåŠ¡è¿è¡Œä¸­ (Event Loop Mode)...")
        
        while True:
            try:
                # 1. å¤„ç†å¾…å‘é€çš„æ¶ˆæ¯ (ä¼˜å…ˆçº§é«˜)
                self._process_outbox()
                
                # 2. è·å–å¹¶å¤„ç†æ–°æ¶ˆæ¯
                self._handle_new_messages()
                
                # 3. ç¨å¾®ä¼‘çœ ï¼Œé™ä½ CPU å ç”¨
                time.sleep(1)
                
            except KeyboardInterrupt:
                break
            except Exception as e:
                print(f"âš ï¸ ä¸»å¾ªç¯å¼‚å¸¸: {e}")
                time.sleep(1)
bot_core.py
ä»wxautoå¯¼å…¥å¾®ä¿¡
ï¼Œå¯¼å…¥æ—¶é—´
ï¼Œä»
bridge_javaå¯¼å…¥push_to_java
å¯¼å…¥é…ç½®
ï¼Œå¯¼å…¥ä½œç³»ç»Ÿã€‚
ç±»å¾®ä¿¡æœºå™¨äººï¼š
def å¼€å§‹ï¼ˆselfï¼‰ï¼š
printï¼ˆâ€œæ­£åœ¨åˆå§‹åŒ–å¾®ä¿¡å®¢æˆ·ç«¯...â€ï¼‰
self.wx = å¾®ä¿¡ï¼ˆï¼‰
code
ä»£ç 
# å‘é€æ¶ˆæ¯é˜Ÿåˆ— (ç”Ÿäº§è€…: Flask, æ¶ˆè´¹è€…: ä¸»çº¿ç¨‹)
    self.send_queue = queue.Queue()
    
    self._init_listeners()

def _init_listeners(self):
    """åˆå§‹åŒ–ç›‘å¬åˆ—è¡¨"""
    
    # 1. å®šä¹‰ä¸€ä¸ªç©ºçš„å›è°ƒå‡½æ•°
    # ä½œç”¨ï¼šä»…ä»…æ˜¯ä¸ºäº†æ»¡è¶³ AddListenChat çš„å‚æ•°è¦æ±‚ï¼Œå®é™…é€»è¾‘ç”±ä¸‹é¢çš„ _handle_recv_msgs å¤„ç†
    def _dummy_callback(msg, chat):
        pass 

    for nickname in config.LISTEN_LIST:
        # 2. ä¼ å…¥ callback å‚æ•°
        self.wx.AddListenChat(nickname=nickname, callback=_dummy_callback)
        print(f"âœ… å·²æ·»åŠ ç›‘å¬: {nickname}")

def send_msg(self, who, content):
    """
    ä¾› Server è°ƒç”¨ï¼šå°†å‘é€ä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—ã€‚
    """
    self.send_queue.put({"who": who, "content": content})
    print(f"[Flask -> Queue] æ¶ˆæ¯å·²å…¥é˜Ÿï¼Œå¾…å‘é€ç»™: {who}")

def _handle_send_queue(self):
    """
    ä»é˜Ÿåˆ—å¤„ç†å‘é€ä»»åŠ¡ï¼ˆè¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼‰
    """
    while not self.send_queue.empty():
        try:
            task = self.send_queue.get()
            who = task['who']
            content = task['content']

            print(f"--> æ­£åœ¨å‘é€ç»™ {who}...")
            
            # åˆ‡æ¢çª—å£
            self.wx.ChatWith(who)
            
            # å¤„ç†æ–‡ä»¶æˆ–æ–‡æœ¬
            if content.startswith("[FILE]"):
                file_path = content.replace("[FILE]", "")
                if os.path.exists(file_path):
                    self.wx.SendFiles(file_path)
                    print(f"    æ–‡ä»¶å‘é€æˆåŠŸ: {file_path}")
                else:
                    print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
                    self.wx.SendMsg(f"é”™è¯¯ï¼šæ–‡ä»¶ä¸å­˜åœ¨ {file_path}")
            else:
                self.wx.SendMsg(content)
                print(f"    æ–‡æœ¬å‘é€æˆåŠŸ: {content[:20]}...")
            
            time.sleep(0.5)
            
        except Exception as e:
            print(f"âŒ å‘é€è¿‡ç¨‹å‡ºé”™: {e}")

def _handle_recv_msgs(self):
    """
    è·å–ç›‘å¬æ¶ˆæ¯ï¼ˆè¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼‰
    """
    try:
        # GetListenMessage ä¼šå»æ£€æŸ¥ AddListenChat æ·»åŠ çš„çª—å£
        msgs = self.wx.GetListenMessage()
        
        for chat, msg_list in msgs.items():
            for msg in msg_list:
                self._process_single_msg(msg, chat)
    except Exception as e:
        print(f"âŒ è·å–æ¶ˆæ¯å¼‚å¸¸: {e}")

def _process_single_msg(self, msg, chat):
    """å¤„ç†å•æ¡æ¶ˆæ¯"""
    if msg.sender == 'Self': 
        return
    if hasattr(config, 'SELF_WX_NAME') and msg.sender == config.SELF_WX_NAME:
        return
    if msg.type == 'sys':
        return

    print(f"<-- æ”¶åˆ°æ¶ˆæ¯ [{chat.who}]: {msg.content[:20]}...")

    # å¤„ç†æ–‡ä»¶ä¸‹è½½
    final_content = msg.content
    if msg.type in ('image', 'video', 'file'):
        try:
            save_path = msg.download()
            final_content = f"[FILE]{save_path}"
            print(f"    æ–‡ä»¶å·²ä¸‹è½½: {save_path}")
        except Exception as e:
            print(f"âš ï¸ ä¸‹è½½å¤±è´¥: {e}")

    # æ¨é€ç»™ Java
    data = {
        "sender": chat.who,
        "content": final_content,
        "type": msg.type,
        "timestamp": int(time.time() * 1000)
    }
    push_to_java(data)

def run_listener(self):
    """ä¸»ç¨‹åºå¾ªç¯"""
    print("ğŸš€ å¾®ä¿¡æœºå™¨äººä¸»å¾ªç¯å·²å¯åŠ¨ (Event Loop Mode)...")
    while True:
        try:
            # 1. å¤„ç†å‘é€
            self._handle_send_queue()
            
            # 2. å¤„ç†æ¥æ”¶
            self._handle_recv_msgs()
            
            # 3. ä¼‘çœ 
            time.sleep(1)
            
        except KeyboardInterrupt:
            print("ğŸ›‘ ç¨‹åºåœæ­¢")
            break
        except Exception as e:
            print(f"âš ï¸ ä¸»å¾ªç¯å‘ç”ŸæœªçŸ¥é”™è¯¯: {e}")
            time.sleep(2)
å•ä¾‹æ¨¡å¼å®ä¾‹åŒ–
bot = å¾®ä¿¡æœºå™¨äººï¼ˆï¼‰
bridge_java.pyæ–‡ä»¶
bridge_java.py
import requests
import import config 
from concurrent.futures import ThreadPoolExecutor
åˆ›å»ºä¸€ä¸ªæœ€å¤§å®¹çº³ 5 ä¸ªå¹¶å‘è¯·æ±‚çš„çº¿ç¨‹æ± 
é˜²æ­¢ç¾¤èŠæ¶ˆæ¯çˆ†å‘æ—¶ï¼Œåˆ›å»ºè¿‡å¤šçº¿ç¨‹å¯¼è‡´èµ„æºè€—å°½
executor = ThreadPoolExecutorï¼ˆmax_workers=5ï¼‰
def _do_postï¼ˆpayloadï¼‰ï¼š
â€œâ€â€œå®é™…æ‰§è¡Œ HTTP POST è¯·æ±‚çš„å‡½æ•°â€â€œâ€try
ï¼š
# è°ƒè¯•è¾“å‡º
content_snippet = strï¼ˆpayload.getï¼ˆ'content'ï¼Œ 'No Content'ï¼‰ï¼‰[ï¼š20].replaceï¼ˆ'\n'ï¼Œ ' 'ï¼‰
printï¼ˆfâ€œ[Python -> Java] æ¨é€ï¼š {content_snippet}...â€ï¼‰
code
ä»£ç 
# è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œé˜²æ­¢ç½‘ç»œé˜»å¡
    response = requests.post(config.JAVA_API_URL, json=payload, timeout=3)
    
    if response.status_code != 200:
        print(f"âŒ Javaç«¯è¿”å›é”™è¯¯: {response.status_code}, Response: {response.text[:50]}")
except Exception as e:
    print(f"âŒ æ¨é€ Java å¤±è´¥: {e}")
def push_to_javaï¼ˆmsg_dataï¼‰ï¼š
â€œâ€
â€œå°†æ¶ˆæ¯æ¨é€ä»»åŠ¡æäº¤ç»™çº¿ç¨‹æ± ï¼Œå®ç°éé˜»å¡å‘é€ã€‚
â€œâ€â€œ#
 æäº¤ç»™çº¿ç¨‹æ± å¤„ç†
executor.submitï¼ˆ_do_postï¼Œ msg_dataï¼‰
server.py æ–‡ä»¶
server.py
from flask import Flaskï¼Œ requestï¼Œ jsonify
from bot_core import bot
import config
app = Flaskï¼ˆåç§°)
@app.routeï¼ˆ'/send'ï¼Œ methods=['POST']ï¼‰
def handle_send_commandï¼ˆï¼‰ï¼š
â€œâ€â€œæ¥æ”¶
 Java çš„ POST è¯·æ±‚
â€â€œdata
 = request.json
å¦‚æœä¸æ˜¯ data æˆ– 'who' ä¸åœ¨ dataï¼Œæˆ– 'content' ä¸åœ¨ dataï¼š
return jsonifyï¼ˆ{â€statusâ€œï¼š â€errorâ€œï¼Œ â€messageâ€œï¼š â€å‚æ•°ç¼ºå¤±â€œ}ï¼‰ï¼Œ 400
code
ä»£ç 
who = data['who']
content = data['content']

try:
    # è¿™é‡Œåªè´Ÿè´£å…¥é˜Ÿï¼Œä¸ä¼šé˜»å¡ï¼Œä¹Ÿä¸ä¼šç›´æ¥æ“ä½œ UI
    bot.send_msg(who, content)
    return jsonify({
        "status": "queued", 
        "message": f"æ¶ˆæ¯å·²åŠ å…¥å‘é€é˜Ÿåˆ—: {who}"
    }), 200
except Exception as e:
    print(f"âŒ å…¥é˜Ÿå¤±è´¥: {e}")
    return jsonify({"status": "error", "message": str(e)}), 500
main.pyæ–‡ä»¶
main.py
ä»æœåŠ¡å™¨å¯¼å…¥åº”ç”¨
å¯¼å…¥çº¿ç¨‹
bot_coreå¯¼å…¥æœºå™¨äºº
å¯¼å…¥é…ç½®æ–‡ä»¶
def run_flaskï¼ˆï¼‰ï¼š
â€œâ€â€œåœ¨ç‹¬ç«‹çº¿ç¨‹è¿è¡Œ Flask Serverâ€â€œâ€#
 use_reloader=False å¿…é¡»åŠ ï¼Œå¦åˆ™ Flask ä¼šå¯åŠ¨ä¸¤ä¸ªè¿›ç¨‹å¯¼è‡´ Main çº¿ç¨‹é€»è¾‘è·‘ä¸¤æ¬¡
app.runï¼ˆhost='0.0.0.0'ï¼Œ port=config.PYTHON_SERVER_PORTï¼Œ debug=Falseï¼Œ use_reloader=Falseï¼‰
å¦‚æœåç§° == 'ä¸»è¦è§’è‰²'ï¼š
printï¼ˆâ€œ--- å¯åŠ¨ç¨‹åº ---â€ï¼‰
code
ä»£ç 
# 1. å¯åŠ¨ Flask çº¿ç¨‹ (API æœåŠ¡)
# Flask çº¿ç¨‹åªè´Ÿè´£æ”¶ HTTP è¯·æ±‚å¹¶æŠŠä»»åŠ¡ put åˆ° bot çš„é˜Ÿåˆ—é‡Œ
t_flask = threading.Thread(target=run_flask, daemon=True)
t_flask.start()
print(f"ğŸš€ Flask æœåŠ¡å™¨è¿è¡Œåœ¨ç«¯å£ {config.PYTHON_SERVER_PORT}")

# 2. ä¸»çº¿ç¨‹è¿è¡Œ Bot é€»è¾‘ (UI æ“ä½œ)
# æ‰€æœ‰æ¶‰åŠ wxauto çš„æ“ä½œ (ChatWith, SendMsg, GetListenMessage) éƒ½åœ¨è¿™é‡Œæ‰§è¡Œ
bot.run_listener()